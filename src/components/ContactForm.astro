---
import { getLangFromUrl, useTranslations } from '../i18n/utils'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)

// reCAPTCHA site key - set PUBLIC_RECAPTCHA_SITE_KEY in your .env file
const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || ''
---

<!-- Load reCAPTCHA v3 script -->
<script is:inline define:vars={{ RECAPTCHA_SITE_KEY }}>
  window.RECAPTCHA_SITE_KEY = RECAPTCHA_SITE_KEY;
</script>
{RECAPTCHA_SITE_KEY && (
  <script is:inline src={`https://www.google.com/recaptcha/api.js?render=${RECAPTCHA_SITE_KEY}`}></script>
)}

<section
  id='contact'
  class='py-16 sm:py-20 lg:py-24 bg-slate-50'
  x-data={`{
    submitted: false,
    loading: false,
    errors: {},
    recaptchaError: false,
    submitError: false,
    touched: {},
    validateField(name, value) {
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;
      const phoneRegex = /^[0-9+\\-\\s()]{9,15}$/;
      switch(name) {
        case 'name':
          if (!value?.trim()) return 'required';
          if (value.trim().length < 2) return 'minLength';
          if (value.trim().length > 100) return 'maxLength';
          return null;
        case 'email':
          if (!value?.trim()) return 'required';
          if (!emailRegex.test(value.trim())) return 'invalid';
          return null;
        case 'phone':
          if (!value?.trim()) return 'required';
          if (!phoneRegex.test(value.trim())) return 'invalid';
          return null;
        case 'message':
          if (!value?.trim()) return 'required';
          if (value.trim().length < 10) return 'minLength';
          if (value.trim().length > 2000) return 'maxLength';
          return null;
        default:
          return null;
      }
    },
    validateForm(form) {
      this.errors = {};
      this.recaptchaError = false;
      this.submitError = false;
      const data = new FormData(form);
      const fields = ['name', 'email', 'phone', 'message'];
      fields.forEach(field => {
        const error = this.validateField(field, data.get(field));
        if (error) this.errors[field] = error;
      });
      return Object.keys(this.errors).length === 0;
    },
    onBlur(e) {
      const { name, value } = e.target;
      this.touched[name] = true;
      const error = this.validateField(name, value);
      if (error) {
        this.errors[name] = error;
      } else {
        delete this.errors[name];
      }
    },
    onInput(e) {
      const { name, value } = e.target;
      if (this.touched[name]) {
        const error = this.validateField(name, value);
        if (error) {
          this.errors[name] = error;
        } else {
          delete this.errors[name];
        }
      }
    },
    async handleSubmit(e) {
      e.preventDefault();
      if (!this.validateForm(e.target)) {
        return;
      }
      this.loading = true;
      try {
        if (window.RECAPTCHA_SITE_KEY && typeof grecaptcha !== 'undefined') {
          const token = await grecaptcha.execute(window.RECAPTCHA_SITE_KEY, { action: 'contact_form' });
          const tokenInput = e.target.querySelector('input[name="g-recaptcha-response"]');
          if (tokenInput) {
            tokenInput.value = token;
          }
        }
        const formData = new FormData(e.target);
        const contactData = {
          name: formData.get('name'),
          email: formData.get('email'),
          phone: formData.get('phone'),
          company: formData.get('company') || '',
          service: formData.get('service') || '',
          message: formData.get('message'),
          language: formData.get('language')
        };
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(contactData)
        });
        if (response.ok) {
          this.submitted = true;
          this.loading = false;
          e.target.reset();
        } else {
          throw new Error('Form submission failed');
        }
      } catch (error) {
        console.error('Submit error:', error);
        if (error.message?.includes('reCAPTCHA') || error.message?.includes('grecaptcha')) {
          this.recaptchaError = true;
        } else {
          this.submitError = true;
        }
        this.loading = false;
      }
    },
    resetForm() {
      this.submitted = false;
      this.errors = {};
      this.touched = {};
    }
  }`}>
  <div class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'>
    <div class='grid lg:grid-cols-2 gap-8 lg:gap-16'>
      <!-- Form -->
      <div class='order-2 lg:order-1'>
        <div class='mb-6 sm:mb-8'>
          <h2 class='text-2xl sm:text-3xl lg:text-4xl font-bold text-slate-800 mb-3 sm:mb-4'>
            {t('form.title')}
          </h2>
          <p class='text-base sm:text-lg text-slate-600'>
            {t('form.subtitle')}
          </p>
        </div>

        <!-- Success Message -->
        <div x-show='submitted' x-cloak class='text-center py-8'>
          <div class='w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6'>
            <svg class='w-8 h-8 text-green-600' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
              <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 13l4 4L19 7'></path>
            </svg>
          </div>
          <h3 class='text-2xl font-bold text-slate-800 mb-3'>
            {lang === 'vi' ? 'Cảm ơn bạn!' : lang === 'en' ? 'Thank you!' : 'ありがとうございます！'}
          </h3>
          <p class='text-slate-600 mb-6'>
            {lang === 'vi' ? 'Chúng tôi đã nhận được tin nhắn của bạn và sẽ phản hồi trong thời gian sớm nhất.' : lang === 'en' ? 'We have received your message and will get back to you as soon as possible.' : 'メッセージを受け取りました。できるだけ早くご連絡いたします。'}
          </p>
          <button
            type='button'
            @click='resetForm()'
            class='inline-flex items-center justify-center bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition-all'>
            {lang === 'vi' ? 'Gửi tin nhắn khác' : lang === 'en' ? 'Send another message' : '別のメッセージを送る'}
          </button>
        </div>

        <form
          @submit='handleSubmit'
          class='space-y-4 sm:space-y-5'
          x-show='!submitted'
          x-cloak>
          <input type='hidden' name='language' value={lang} />
          <input type='hidden' name='g-recaptcha-response' value='' />

          <div class='grid sm:grid-cols-2 gap-4 sm:gap-5'>
            <!-- Name -->
            <div>
              <label class='block text-sm font-medium text-slate-700 mb-1.5'>
                {t('form.name')} <span class='text-red-500'>*</span>
              </label>
              <input
                type='text'
                name='name'
                required
                maxlength='100'
                @blur='onBlur'
                @input='onInput'
                class='w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all bg-white text-sm sm:text-base'
                :class="{ 'border-red-400 bg-red-50 focus:ring-red-500': errors.name }"
                placeholder={t('form.name')}
              />
              <p x-show='errors.name' x-cloak class='mt-1 text-xs text-red-500'>
                <span x-show="errors.name === 'required'">{lang === 'vi' ? 'Vui lòng nhập họ tên' : lang === 'en' ? 'Please enter your name' : 'お名前を入力してください'}</span>
                <span x-show="errors.name === 'minLength'">{lang === 'vi' ? 'Họ tên phải có ít nhất 2 ký tự' : lang === 'en' ? 'Name must be at least 2 characters' : '名前は2文字以上で入力してください'}</span>
                <span x-show="errors.name === 'maxLength'">{lang === 'vi' ? 'Họ tên không được quá 100 ký tự' : lang === 'en' ? 'Name must not exceed 100 characters' : '名前は100文字以内で入力してください'}</span>
              </p>
            </div>

            <!-- Email -->
            <div>
              <label class='block text-sm font-medium text-slate-700 mb-1.5'>
                {t('form.email')} <span class='text-red-500'>*</span>
              </label>
              <input
                type='email'
                name='email'
                required
                @blur='onBlur'
                @input='onInput'
                class='w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all bg-white text-sm sm:text-base'
                :class="{ 'border-red-400 bg-red-50 focus:ring-red-500': errors.email }"
                placeholder={t('form.email')}
              />
              <p x-show='errors.email' x-cloak class='mt-1 text-xs text-red-500'>
                <span x-show="errors.email === 'required'">{lang === 'vi' ? 'Vui lòng nhập email' : lang === 'en' ? 'Please enter your email' : 'メールアドレスを入力してください'}</span>
                <span x-show="errors.email === 'invalid'">{lang === 'vi' ? 'Email không hợp lệ' : lang === 'en' ? 'Please enter a valid email' : '有効なメールアドレスを入力してください'}</span>
              </p>
            </div>
          </div>

          <div class='grid sm:grid-cols-2 gap-4 sm:gap-5'>
            <!-- Phone -->
            <div>
              <label class='block text-sm font-medium text-slate-700 mb-1.5'>
                {t('form.phone')} <span class='text-red-500'>*</span>
              </label>
              <input
                type='tel'
                name='phone'
                required
                @blur='onBlur'
                @input='onInput'
                class='w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all bg-white text-sm sm:text-base'
                :class="{ 'border-red-400 bg-red-50 focus:ring-red-500': errors.phone }"
                placeholder={t('form.phone')}
              />
              <p x-show='errors.phone' x-cloak class='mt-1 text-xs text-red-500'>
                <span x-show="errors.phone === 'required'">{lang === 'vi' ? 'Vui lòng nhập số điện thoại' : lang === 'en' ? 'Please enter your phone number' : '電話番号を入力してください'}</span>
                <span x-show="errors.phone === 'invalid'">{lang === 'vi' ? 'Số điện thoại không hợp lệ (9-15 số)' : lang === 'en' ? 'Please enter a valid phone number (9-15 digits)' : '有効な電話番号を入力してください（9〜15桁）'}</span>
              </p>
            </div>

            <!-- Company -->
            <div>
              <label class='block text-sm font-medium text-slate-700 mb-1.5'>
                {t('form.company')}
              </label>
              <input
                type='text'
                name='company'
                maxlength='100'
                class='w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all bg-white text-sm sm:text-base'
                placeholder={t('form.company')}
              />
            </div>
          </div>

          <!-- Service -->
          <div>
            <label class='block text-sm font-medium text-slate-700 mb-1.5'>
              {t('form.service')}
            </label>
            <select
              name='service'
              class='w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all bg-white text-sm sm:text-base'>
              <option value=''>-- {t('form.service')} --</option>
              <option value='digital-transformation'>{t('services.digital.title')}</option>
              <option value='outsourcing'>{t('services.outsourcing.title')}</option>
              <option value='bpo'>{t('services.bpo.title')}</option>
              <option value='other'>
                {lang === 'vi' && 'Khác'}
                {lang === 'en' && 'Other'}
                {lang === 'ja' && 'その他'}
              </option>
            </select>
          </div>

          <!-- Message -->
          <div>
            <label class='block text-sm font-medium text-slate-700 mb-1.5'>
              {t('form.message')} <span class='text-red-500'>*</span>
            </label>
            <textarea
              name='message'
              rows='4'
              required
              maxlength='2000'
              @blur='onBlur'
              @input='onInput'
              class='w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all bg-white resize-none text-sm sm:text-base'
              :class="{ 'border-red-400 bg-red-50 focus:ring-red-500': errors.message }"
              placeholder={t('form.message')}></textarea>
            <p x-show='errors.message' x-cloak class='mt-1 text-xs text-red-500'>
              <span x-show="errors.message === 'required'">{lang === 'vi' ? 'Vui lòng nhập nội dung tin nhắn' : lang === 'en' ? 'Please enter your message' : 'メッセージを入力してください'}</span>
              <span x-show="errors.message === 'minLength'">{lang === 'vi' ? 'Nội dung phải có ít nhất 10 ký tự' : lang === 'en' ? 'Message must be at least 10 characters' : 'メッセージは10文字以上で入力してください'}</span>
              <span x-show="errors.message === 'maxLength'">{lang === 'vi' ? 'Nội dung không được quá 2000 ký tự' : lang === 'en' ? 'Message must not exceed 2000 characters' : 'メッセージは2000文字以内で入力してください'}</span>
            </p>
          </div>

          <!-- Error Messages -->
          <div x-show='recaptchaError' x-cloak class='p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm'>
            {lang === 'vi' && 'Xác minh reCAPTCHA thất bại. Vui lòng thử lại.'}
            {lang === 'en' && 'reCAPTCHA verification failed. Please try again.'}
            {lang === 'ja' && 'reCAPTCHA認証に失敗しました。もう一度お試しください。'}
          </div>
          <div x-show='submitError' x-cloak class='p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm'>
            {lang === 'vi' && 'Có lỗi xảy ra khi gửi tin nhắn. Vui lòng thử lại.'}
            {lang === 'en' && 'An error occurred while sending your message. Please try again.'}
            {lang === 'ja' && 'メッセージの送信中にエラーが発生しました。もう一度お試しください。'}
          </div>

          <!-- Submit -->
          <button
            type='submit'
            class='w-full bg-indigo-600 text-white py-3.5 sm:py-4 rounded-xl font-semibold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-500/25 hover:shadow-xl hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed btn-press text-sm sm:text-base'
            :disabled='loading'>
            <span x-show='!loading'>{t('form.submit')}</span>
            <span x-show='loading' class='flex items-center justify-center' x-cloak>
              <svg class='animate-spin -ml-1 mr-3 h-5 w-5 text-white' fill='none' viewBox='0 0 24 24'>
                <circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4'></circle>
                <path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'></path>
              </svg>
              {t('form.sending')}
            </span>
          </button>

          <!-- reCAPTCHA Notice -->
          {RECAPTCHA_SITE_KEY && (
            <p class='text-xs text-slate-400 text-center'>
              {lang === 'vi' && 'Trang này được bảo vệ bởi reCAPTCHA và '}
              {lang === 'en' && 'This site is protected by reCAPTCHA and the Google '}
              {lang === 'ja' && 'このサイトはreCAPTCHAで保護されており、Googleの'}
              <a href='https://policies.google.com/privacy' class='underline hover:text-slate-600' target='_blank' rel='noopener'>
                {lang === 'vi' ? 'Chính sách bảo mật' : lang === 'en' ? 'Privacy Policy' : 'プライバシーポリシー'}
              </a>
              {lang === 'vi' ? ' và ' : lang === 'en' ? ' and ' : 'と'}
              <a href='https://policies.google.com/terms' class='underline hover:text-slate-600' target='_blank' rel='noopener'>
                {lang === 'vi' ? 'Điều khoản dịch vụ' : lang === 'en' ? 'Terms of Service' : '利用規約'}
              </a>
              {lang === 'vi' ? ' của Google được áp dụng.' : lang === 'en' ? ' apply.' : 'が適用されます。'}
            </p>
          )}
        </form>
      </div>

      <!-- Contact Info -->
      <div class='order-1 lg:order-2'>
        <div class='bg-white rounded-2xl shadow-elegant-lg p-6 sm:p-8 lg:p-10 sticky top-24'>
          <h3 class='text-xl sm:text-2xl font-bold text-slate-800 mb-6'>
            {t('footer.contact')}
          </h3>

          <div class='space-y-5'>
            <div class='flex items-start gap-4'>
              <div class='w-11 h-11 sm:w-12 sm:h-12 bg-indigo-100 rounded-xl flex items-center justify-center shrink-0'>
                <svg class='w-5 h-5 sm:w-6 sm:h-6 text-indigo-600' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                  <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z'></path>
                </svg>
              </div>
              <div>
                <p class='font-semibold text-slate-800 mb-1 text-sm sm:text-base'>{t('footer.email')}</p>
                <p class='text-slate-600 text-sm sm:text-base'>contact@sobavn.com</p>
              </div>
            </div>

            <div class='flex items-start gap-4'>
              <div class='w-11 h-11 sm:w-12 sm:h-12 bg-violet-100 rounded-xl flex items-center justify-center shrink-0'>
                <svg class='w-5 h-5 sm:w-6 sm:h-6 text-violet-600' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                  <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'></path>
                </svg>
              </div>
              <div>
                <p class='font-semibold text-slate-800 mb-1 text-sm sm:text-base'>{t('footer.hours')}</p>
                <p class='text-slate-600 text-sm sm:text-base'>{t('footer.hours.value')}</p>
              </div>
            </div>
          </div>

          <!-- Social Links -->
          <div class='mt-8 pt-6 border-t border-slate-100'>
            <p class='font-medium text-slate-700 mb-4 text-sm sm:text-base'>
              {lang === 'vi' && 'Kết nối với chúng tôi'}
              {lang === 'en' && 'Connect with us'}
              {lang === 'ja' && 'フォローする'}
            </p>
            <div class='flex gap-3'>
              <a href='#' class='w-10 h-10 bg-slate-100 hover:bg-indigo-600 rounded-xl flex items-center justify-center text-slate-500 hover:text-white transition-all' aria-label='LinkedIn'>
                <svg class='w-5 h-5' fill='currentColor' viewBox='0 0 24 24'>
                  <path d='M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z'></path>
                </svg>
              </a>
              <a href='#' class='w-10 h-10 bg-slate-100 hover:bg-indigo-600 rounded-xl flex items-center justify-center text-slate-500 hover:text-white transition-all' aria-label='Facebook'>
                <svg class='w-5 h-5' fill='currentColor' viewBox='0 0 24 24'>
                  <path d='M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z'></path>
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
