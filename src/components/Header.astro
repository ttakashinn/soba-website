---
import { getLangFromUrl, useTranslations } from '../i18n/utils'
import { languages } from '../i18n/config'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)

// URL mapping between languages
const urlMap: Record<string, Record<'vi' | 'en' | 'ja', string>> = {
  '/': { vi: '/', en: '/en/', ja: '/ja/' },
  '/en/': { vi: '/', en: '/en/', ja: '/ja/' },
  '/ja/': { vi: '/', en: '/en/', ja: '/ja/' },
  '/contact': { vi: '/contact', en: '/en/contact', ja: '/ja/contact' },
  '/en/contact': { vi: '/contact', en: '/en/contact', ja: '/ja/contact' },
  '/ja/contact': { vi: '/contact', en: '/en/contact', ja: '/ja/contact' },
  '/about': { vi: '/about', en: '/en/about', ja: '/ja/about' },
  '/en/about': { vi: '/about', en: '/en/about', ja: '/ja/about' },
  '/ja/about': { vi: '/about', en: '/en/about', ja: '/ja/about' },
  '/services': { vi: '/services', en: '/en/services', ja: '/ja/services' },
  '/en/services': { vi: '/services', en: '/en/services', ja: '/ja/services' },
  '/ja/services': { vi: '/services', en: '/en/services', ja: '/ja/services' },
  '/portfolio': { vi: '/portfolio', en: '/en/portfolio', ja: '/ja/portfolio' },
  '/en/portfolio': { vi: '/portfolio', en: '/en/portfolio', ja: '/ja/portfolio' },
  '/ja/portfolio': { vi: '/portfolio', en: '/en/portfolio', ja: '/ja/portfolio' },
}

const currentPath = Astro.url.pathname

const getAlternateUrl = (targetLang: 'vi' | 'en' | 'ja') => {
  const mapping = urlMap[currentPath]
  if (mapping) return mapping[targetLang]
  if (targetLang === 'vi') return currentPath.replace(/^\/(en|ja)/, '') || '/'
  return `/${targetLang}${currentPath.replace(/^\/(en|ja)/, '') || '/'}`
}

const alternateUrls = {
  vi: getAlternateUrl('vi'),
  en: getAlternateUrl('en'),
  ja: getAlternateUrl('ja'),
}

const navLinks = {
  services: lang === 'vi' ? '/services' : `/${lang}/services`,
  portfolio: lang === 'vi' ? '/portfolio' : `/${lang}/portfolio`,
  about: lang === 'vi' ? '/about' : `/${lang}/about`,
  contact: lang === 'vi' ? '/contact' : `/${lang}/contact`,
  home: lang === 'vi' ? '/' : `/${lang}/`,
}
---

<header
  class='fixed top-0 left-0 right-0 z-50 transition-all duration-300'
  x-data='{ mobileMenuOpen: false, langMenuOpen: false, scrolled: false }'
  x-init="window.addEventListener('scroll', () => { scrolled = window.scrollY > 20 })"
  :class="scrolled ? 'bg-white/95 backdrop-blur-md shadow-sm' : 'bg-transparent'">
  <nav class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'>
    <div class='flex items-center justify-between h-16 lg:h-20'>
      <!-- Logo -->
      <a href={navLinks.home} class='flex items-center gap-3 group'>
        <img
          src='/logo.png'
          alt='SOBA GROUP Logo'
          class='w-9 h-9 lg:w-10 lg:h-10 rounded-lg object-contain transition-transform group-hover:scale-105'
        />
        <span class='text-lg lg:text-xl font-bold text-slate-800'>SOBA GROUP</span>
      </a>

      <!-- Desktop Menu -->
      <div class='hidden lg:flex items-center gap-1'>
        <a
          href={navLinks.services}
          class='px-4 py-2 text-slate-600 hover:text-indigo-600 transition-colors font-medium rounded-lg hover:bg-slate-50'>
          {t('nav.services')}
        </a>
        <a
          href={navLinks.portfolio}
          class='px-4 py-2 text-slate-600 hover:text-indigo-600 transition-colors font-medium rounded-lg hover:bg-slate-50'>
          {t('nav.portfolio')}
        </a>
        <a
          href={navLinks.about}
          class='px-4 py-2 text-slate-600 hover:text-indigo-600 transition-colors font-medium rounded-lg hover:bg-slate-50'>
          {t('nav.about')}
        </a>

        <!-- Language Switcher -->
        <div class='relative ml-2' @click.away='langMenuOpen = false'>
          <button
            @click='langMenuOpen = !langMenuOpen'
            class='flex items-center gap-2 px-3 py-2 text-slate-600 hover:text-indigo-600 transition-colors rounded-lg hover:bg-slate-50'>
            <span class='text-lg'>
              {lang === 'vi' ? 'ðŸ‡»ðŸ‡³' : lang === 'en' ? 'ðŸ‡¬ðŸ‡§' : 'ðŸ‡¯ðŸ‡µ'}
            </span>
            <svg
              class='w-4 h-4 transition-transform'
              :class="{ 'rotate-180': langMenuOpen }"
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'>
              <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'></path>
            </svg>
          </button>

          <div
            x-show='langMenuOpen'
            x-transition:enter='transition ease-out duration-200'
            x-transition:enter-start='opacity-0 scale-95 -translate-y-2'
            x-transition:enter-end='opacity-100 scale-100 translate-y-0'
            x-transition:leave='transition ease-in duration-150'
            x-transition:leave-start='opacity-100 scale-100 translate-y-0'
            x-transition:leave-end='opacity-0 scale-95 -translate-y-2'
            class='absolute right-0 mt-2 w-44 bg-white rounded-xl shadow-elegant-lg py-2 border border-slate-100'
            style='display: none;'>
            <a
              href={alternateUrls.vi}
              class='flex items-center gap-3 px-4 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors'
              class:list={[{ 'bg-indigo-50 text-indigo-600 font-medium': lang === 'vi' }]}>
              <span class='text-lg'>ðŸ‡»ðŸ‡³</span>
              <span>Tiáº¿ng Viá»‡t</span>
            </a>
            <a
              href={alternateUrls.en}
              class='flex items-center gap-3 px-4 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors'
              class:list={[{ 'bg-indigo-50 text-indigo-600 font-medium': lang === 'en' }]}>
              <span class='text-lg'>ðŸ‡¬ðŸ‡§</span>
              <span>English</span>
            </a>
            <a
              href={alternateUrls.ja}
              class='flex items-center gap-3 px-4 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors'
              class:list={[{ 'bg-indigo-50 text-indigo-600 font-medium': lang === 'ja' }]}>
              <span class='text-lg'>ðŸ‡¯ðŸ‡µ</span>
              <span>æ—¥æœ¬èªž</span>
            </a>
          </div>
        </div>

        <a
          href={navLinks.contact}
          class='ml-4 bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-medium hover:bg-indigo-700 transition-all shadow-sm hover:shadow-md btn-press'>
          {t('nav.contact')}
        </a>
      </div>

      <!-- Mobile Language Switcher & Menu Button -->
      <div class='flex items-center gap-1 lg:hidden'>
        <!-- Mobile Language Switcher Dropdown -->
        <div class='relative' @click.away='langMenuOpen = false'>
          <button
            @click='langMenuOpen = !langMenuOpen'
            class='flex items-center gap-1 p-2 text-slate-600 hover:text-indigo-600 transition-colors rounded-lg hover:bg-slate-50'>
            <span class='text-lg'>
              {lang === 'vi' ? 'ðŸ‡»ðŸ‡³' : lang === 'en' ? 'ðŸ‡¬ðŸ‡§' : 'ðŸ‡¯ðŸ‡µ'}
            </span>
            <svg
              class='w-3 h-3 transition-transform'
              :class="{ 'rotate-180': langMenuOpen }"
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'>
              <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'></path>
            </svg>
          </button>

          <div
            x-show='langMenuOpen'
            x-transition:enter='transition ease-out duration-200'
            x-transition:enter-start='opacity-0 scale-95 -translate-y-2'
            x-transition:enter-end='opacity-100 scale-100 translate-y-0'
            x-transition:leave='transition ease-in duration-150'
            x-transition:leave-start='opacity-100 scale-100 translate-y-0'
            x-transition:leave-end='opacity-0 scale-95 -translate-y-2'
            class='absolute right-0 mt-2 w-36 bg-white rounded-xl shadow-lg py-2 border border-slate-100'
            style='display: none;'>
            <a
              href={alternateUrls.vi}
              class='flex items-center gap-2 px-3 py-2 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors text-sm'
              class:list={[{ 'bg-indigo-50 text-indigo-600 font-medium': lang === 'vi' }]}>
              <span>ðŸ‡»ðŸ‡³</span>
              <span>Tiáº¿ng Viá»‡t</span>
            </a>
            <a
              href={alternateUrls.en}
              class='flex items-center gap-2 px-3 py-2 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors text-sm'
              class:list={[{ 'bg-indigo-50 text-indigo-600 font-medium': lang === 'en' }]}>
              <span>ðŸ‡¬ðŸ‡§</span>
              <span>English</span>
            </a>
            <a
              href={alternateUrls.ja}
              class='flex items-center gap-2 px-3 py-2 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors text-sm'
              class:list={[{ 'bg-indigo-50 text-indigo-600 font-medium': lang === 'ja' }]}>
              <span>ðŸ‡¯ðŸ‡µ</span>
              <span>æ—¥æœ¬èªž</span>
            </a>
          </div>
        </div>

        <!-- Mobile Menu Button -->
        <button
          @click='mobileMenuOpen = !mobileMenuOpen'
          class='p-2 rounded-lg hover:bg-slate-100 transition-colors'
          aria-label='Toggle menu'>
          <svg class='w-6 h-6 text-slate-700' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
            <path
              x-show='!mobileMenuOpen'
              stroke-linecap='round'
              stroke-linejoin='round'
              stroke-width='2'
              d='M4 6h16M4 12h16M4 18h16'></path>
            <path
              x-show='mobileMenuOpen'
              stroke-linecap='round'
              stroke-linejoin='round'
              stroke-width='2'
              d='M6 18L18 6M6 6l12 12'
              style='display: none;'></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div
      x-show='mobileMenuOpen'
      x-transition:enter='transition ease-out duration-200'
      x-transition:enter-start='opacity-0 -translate-y-4'
      x-transition:enter-end='opacity-100 translate-y-0'
      x-transition:leave='transition ease-in duration-150'
      x-transition:leave-start='opacity-100 translate-y-0'
      x-transition:leave-end='opacity-0 -translate-y-4'
      class='lg:hidden py-4 border-t border-slate-100 bg-white'
      style='display: none;'>
      <div class='space-y-1'>
        <a
          href={navLinks.services}
          class='block px-4 py-3 text-slate-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors font-medium'>
          {t('nav.services')}
        </a>
        <a
          href={navLinks.portfolio}
          class='block px-4 py-3 text-slate-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors font-medium'>
          {t('nav.portfolio')}
        </a>
        <a
          href={navLinks.about}
          class='block px-4 py-3 text-slate-700 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors font-medium'>
          {t('nav.about')}
        </a>
      </div>

      <div class='mt-4 pt-4 border-t border-slate-100 px-4'>
        <a
          href={navLinks.contact}
          class='block w-full text-center bg-indigo-600 text-white py-3 rounded-xl font-medium hover:bg-indigo-700 transition-colors'>
          {t('nav.contact')}
        </a>
      </div>
    </div>
  </nav>
</header>

<!-- Spacer for fixed header -->
<div class='h-16 lg:h-20'></div>
